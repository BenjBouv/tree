<!doctype html>
<meta charset=utf-8>
<title>Our Awesome Code Editor</title>

<link rel=stylesheet href=/cm/lib/codemirror.css>
<link rel=stylesheet href=/cm/theme/neat.css>
<link rel=stylesheet href=/cm/theme/elegant.css>
<link rel=stylesheet href=/cm/theme/night.css>
<link rel=stylesheet href=/cm/theme/monokai.css>
<link rel=stylesheet href=/cm/theme/cobalt.css>
<link rel=stylesheet href=/cm/theme/eclipse.css>
<link rel=stylesheet href=/cm/theme/rubyblue.css>
<link rel=stylesheet href=/cm/lib/util/dialog.css>

<script src=/js/diff_match_patch.js></script>
<script src=/js/scout.js></script>
<script src=/js/plugger.js></script>
<script src=/js/split.js></script>
<script src=/cm/lib/codemirror.js></script>
<script src=/cm/lib/util/dialog.js></script>
<script src=/cm/lib/util/searchcursor.js></script>
<script src=/cm/lib/util/search.js></script>
<script src=/cm/codemirror.plug.js></script>

<style>
  html body { margin: 0px; padding: 0px; width: 100%; height: 100%; position: absolute; }
  .CodeMirror-scroll {
    height: auto;
    width: 100%;
    position: fixed;
    bottom: 27px;
    top: 0px;
  }
  .toolbar {
    position: absolute;
    bottom: 0px;
    height: 27px;
  }
</style>

<body class="cm-s-default">

  <div class=toolbar>
    <select onchange="selectTheme(this)">
      <option selected>default</option>
      <option>night</option>
      <option>neat</option>
      <option>monokai</option>
      <option>elegant</option>
      <option>cobalt</option>
      <option>eclipse</option>
      <option>rubyblue</option>
    </select>
    <input type=text style="width: 5em" id=query placeholder=search>
    <button type=button onclick="search()">search</button>
    <input type=text style="width: 5em" id=replace placeholder=replace>
    <button type=button onclick="replace()">replace</button>
  </div>

  <script>

    // Create a CodeMirror2 editor.
    editor = CodeMirrorPlug("{{=path|jsonstring}}", document.body, {
      value: "Loading...",
      mode: "text/plain",
      tabMode: "shift"
    });

    importCodeMirrorMode("{{=mime|jsonstring}}");

    // Change theme.
    function selectTheme(node) {
      var theme = node.options[node.selectedIndex].innerHTML;
      editor.setOption("theme", theme);
      document.body.className = document.body.className.replace(/cm-s-\w+/, "cm-s-"+theme);
    }

    // Search & Replace.
    var lastPos = null, lastQuery = null, marked = [];

    function unmark() {
      for (var i = 0; i < marked.length; ++i) marked[i]();
      marked.length = 0;
    }

    function search() {
      unmark();                     
      var text = document.getElementById("query").value;
      if (!text) return;
      for (var cursor = editor.getSearchCursor(text); cursor.findNext();)
        marked.push(editor.markText(cursor.from(), cursor.to(), "searched"));

      if (lastQuery != text) lastPos = null;
      var cursor = editor.getSearchCursor(text, lastPos || editor.getCursor());
      if (!cursor.findNext()) {
        cursor = editor.getSearchCursor(text);
        if (!cursor.findNext()) return;
      }
      editor.setSelection(cursor.from(), cursor.to());
      lastQuery = text; lastPos = cursor.to();
    }

    function replace() {
      unmark();
      var text = document.getElementById("query").value,
          replace = document.getElementById("replace").value;
      if (!text) return;
      for (var cursor = editor.getSearchCursor(text); cursor.findNext();)
        cursor.replace(replace);
    }

  </script>
</body>
